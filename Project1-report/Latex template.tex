%Template by Mark Jervelund - D1 - 2015 - mjerv15@student.sdu.dk

\documentclass[a4paper,10pt,titlepage]{report}

\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage[english]{babel}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{graphicx}
\usepackage{fancyhdr}
\usepackage{lastpage}
\usepackage{listings}
\usepackage{algorithm}
\usepackage{algpseudocode}
\usepackage[document]{ragged2e}
\usepackage[margin=1in]{geometry}
\usepackage{color}
\usepackage{datenumber}
\usepackage{venndiagram}
\usepackage{chngcntr}
\setdatetoday
\addtocounter{datenumber}{0} %date for dilierry standard is today
\setdatebynumber{\thedatenumber}
\date{}
\setcounter{secnumdepth}{0}
\pagestyle{fancy}
\fancyhf{}

\newcommand{\Z}{\mathbb{Z}}
\lhead{Database Management Systems (DM556))}
\rhead{Mark Jervelund (Mjerv15) Troels Petersen (trpet15)}
\rfoot{Page  \thepage \, of \pageref{LastPage}}
\counterwithin*{equation}{section}

\lstset{
  numbers=left,
  stepnumber=5,    
  firstnumber=1,
  numberfirstline=true
  frame=single,
  breaklines=true,
  postbreak=\raisebox{0ex}[0ex][0ex]{\ensuremath{\color{red}\hookrightarrow\space}}
}

\begin{document}
\begin{titlepage}
\centering
    \vspace*{9\baselineskip}
    \huge
    \bfseries
    Project 1\\
    
    \normalfont 
	\huge    
    Database Management Systems (DM556)  \\[4\baselineskip]
    \normalfont
	\includegraphics[scale=1.5]{SDU_Logo}
    \vfill\ 
    Mark Jervelund (Mjerv15) Troels Petersen (trpet15)
    \vspace{5mm}
    IMADA \\
    \textbf{\datedate} \\[2\baselineskip]
\end{titlepage}
%\renewcommand{\thepage}{\roman{page}}% Roman numerals for page counter
%\tableofcontents

%\newpage
\setcounter{page}{1}
\renewcommand{\thepage}{\arabic{page}}

\lstset{language=Java}          % Set your language (you can change the language for each code-block optionally)
\section{Overall Status}
The overall status of of project is that we hit some bugs we that don't understand and are handing in this part of the project so we can get feedback and fix the current issues when we hand it Project 3.
\section{Division of Labor}
We worked on the project either sitting together at the university or at home remotely working together and spliting tasks when possible.
\subsection{Specification}
We were tasked with implementing the following functions for the bufmgr.java\\

freePage, pinPage, unpinPage, flushPage, flushAllPages, getNumBuffers, getNumUnpinned and pick victim. \\

freePage should deallocate a page from disk.\\

Pinpage should pin a page by incrementing the pincnt by 1, or by loading it into the bufferpool if it isnt in the bufferpool already.\\

Unpinpage should unpin a page, flush it to disk if its dirty and reduce the pincount by 1.\\

Flushpage should save a page to disk if dirty.\\

Flushpages should write all pages to disk if they're dirty.\\

getNumBuffers gets the amount of buffers.\\

getNumUnpinned gets the number of unpinned pages.\\

Pickvictim gets the index for the first unpinned page, and returns -1 if all pages in the pool are pinned.

%\subsection{Design}
%
%Flushpages was implementing using Flushpage as they're almost %doing the same and this reduces the amount of dubplicate code. 

\subsection{Implementation}
Freepage First checks if the page is pinned. If its not, it then deallocates the page from disk.
\lstinputlisting[firstline=103,lastline=110,frame=single]{../dm556-project1/bufmgr/BufMgr.java}
\vspace{10mm}



pinpage
\lstinputlisting[firstline=129,lastline=129,frame=single]{../dm556-project1/bufmgr/BufMgr.java}
First we check if the page is already in the bufferpoll if it is we increment the pin counter
\lstinputlisting[firstline=133,lastline=145,frame=single]{../dm556-project1/bufmgr/BufMgr.java}
If it isnt we pick a victim, and if there isnt any victims we throw an IllegalStateException.
\lstinputlisting[firstline=147,lastline=152,frame=single]{../dm556-project1/bufmgr/BufMgr.java}
If we have a non pinned frame we write this page to disk if its dirty.
\lstinputlisting[firstline=154,lastline=160,frame=single]{../dm556-project1/bufmgr/BufMgr.java}
And if it isnt dirty we  copy or read the new page into the bufferpool and update the pagemap.
\lstinputlisting[firstline=164,lastline=179,frame=single]{../dm556-project1/bufmgr/BufMgr.java}
\vspace{10mm}



unpinpage
\lstinputlisting[firstline=189,lastline=189,frame=single]{../dm556-project1/bufmgr/BufMgr.java}
First we check if the page is pinned. if its not we throw an exception.
\lstinputlisting[firstline=193,lastline=196,frame=single]{../dm556-project1/bufmgr/BufMgr.java}
If its in the buffpool we decrement the pagecounter by 1, and update the pagemap with the new information.
\lstinputlisting[firstline=198,lastline=205,frame=single]{../dm556-project1/bufmgr/BufMgr.java}
\vspace{10mm}



flushpage\\
saves the page to disk, and updates the dirty state of the framedesc. there is some risk of redundancy due to risk of dirty being updated to false by both the flushpage and by the parent function.
\lstinputlisting[firstline=215,lastline=224,frame=single]{../dm556-project1/bufmgr/BufMgr.java}
\vspace{10mm}
flushAllPages loops over the framatab and calls flushpage on them. if they are dirty they are saved and if they are not they are not saved.
\lstinputlisting[firstline=205,lastline=254,frame=single]{../dm556-project1/bufmgr/BufMgr.java}
\vspace{10mm}

getNumBuffers simplys returns the lenght of the bufferpool
\lstinputlisting[firstline=259,lastline=261,frame=single]{../dm556-project1/bufmgr/BufMgr.java}
\vspace{10mm}

getNumUnpinned
\lstinputlisting[firstline=266,lastline=274,frame=single]{../dm556-project1/bufmgr/BufMgr.java}
\vspace{10mm}

Pickvictim is implemented to return the index for the first element with pincnt 0. and if all elements are in use it returns -1 to indicate this.
\lstinputlisting[firstline=37,lastline=46, frame=single]{../dm556-project1/bufmgr/Clock.java}

\subsection{Testing}
From the testing we've done the programs gets into a neverending loop pin/unpin loop at SystemCatalog = new Catalog(false) in Minibase.java line 79 (my file with some print statements for debugging)
\subsection{Conclusion}


\newpage
\section{Appendix}
pickVictim in Clock.java
\lstinputlisting[firstline=37,lastline=46, frame=single]{../dm556-project1/bufmgr/Clock.java}

BufMgr.java
\lstinputlisting[frame=single]{../dm556-project1/bufmgr/BufMgr.java}
\end{document}
